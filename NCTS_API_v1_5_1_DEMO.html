<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCTS API v1.5.1 - Concierge Model Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
        }

        h2 {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 5px;
            margin-top: 40px;
        }

        .intro-section, .demo-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .video-container {
            margin: 20px 0;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .key-points {
            background-color: #e7f3ff;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 20px 0;
        }

            .key-points h4 {
                margin-top: 0;
                color: #0056b3;
            }

            .key-points ul {
                margin-bottom: 0;
                padding-left: 20px;
            }

        .important-note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }

            .important-note strong {
                color: #856404;
            }

        footer {
            margin-top: 50px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .code-block {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 0.9em;
            color: #333;
            margin: 15px 0;
        }

        .timeline {
            margin: 30px 0;
            border-left: 3px solid #007bff;
            padding-left: 20px;
        }

        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }

            .timeline-item:before {
                content: "";
                position: absolute;
                left: -27.5px; /* Adjust based on padding-left + border-width/2 */
                top: 5px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background-color: #fff;
                border: 3px solid #007bff;
            }

        .step-description {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 5px;
        }

        .timestamp-link {
            color: #0056b3;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            padding: 2px 5px;
            background-color: #e8eaf6;
            border-radius: 3px;
            margin-right: 5px;
            display: inline-block;
            margin-bottom: 3px;
        }

            .timestamp-link:hover {
                background-color: #c5cae9;
                text-decoration: underline;
            }

        .highlight {
            background-color: #e8eaf6;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .video-note {
            color: #666;
            font-style: italic;
            margin-top: 5px;
            font-size: 0.9em;
            text-align: center;
        }

        .status-implemented {
            color: #28a745;
            font-weight: bold;
        }

        .status-info {
            color: #17a2b8;
            font-weight: bold;
        }

        a {
            color: #0056b3;
        }

            a:hover {
                color: #003d7a;
            }
        /* Use specific class for checkmark styling if needed */
        .checkmark {
            color: #28a745;
            font-weight: bold;
            margin-right: 3px;
        }

        .arrow {
            margin: 0 5px;
        }
        /* Style for the arrow */
    </style>
</head>
<body>
    <header>
        <h1>NCTS API v1.5.1 - Concierge Model Demo</h1>
        <p>April 2025</p>
    </header>

    <section class="intro-section">
        <h2>Introduction</h2>
        <p>This page demonstrates the current state (v1.5.1) of the NCTS Automation API, implementing the "Concierge Service" model.</p>
        <p>In this model:</p>
        <ol>
            <li>The API finds an available NCT slot.</li>
            <li>The API navigates NCTS.ie (using proxies and random data) to <strong>temporarily hold</strong> that slot for a specific vehicle registration.</li>
            <li>The client application notifies the end-user.</li>
            <li>The end-user <strong>must then manually visit NCTS.ie</strong>, proceed through the normal booking flow (where they'll see the held slot), enter their own details, and <strong>complete the payment on the official site</strong>.</li>
        </ol>
 

    </section>

    <section class="demo-section">
        <h2>1. Demo: Slot Searching (<span class="highlight">/search</span> <span class="arrow">→</span> W1)</h2>
        <p>This video shows initiating a search via the API, the background process using a <strong>test proxy</strong>, and the resulting W1 webhook notification.</p>

        <div class="video-container">
            <iframe id="search-video" src="https://www.youtube.com/embed/0KNRwylWfWw?rel=0&vq=hd720" frameborder="0" allowfullscreen></iframe>
            <p class="video-note">Video shows: API call (Swagger), server logs (mentioning proxy use), browser automation on NCTS.ie, logs showing search completion and W1 dispatch, webhook receiver showing payload.</p>
        </div>

        <div class="timeline">
            <h4>Process Steps:</h4>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 1)">0:01</span> <span class="step-description">API Call Setup:</span> Swagger UI shows request body for <span class="highlight">POST /search</span> with vehicle reg `192D25407`, centers `["Athlone", "Galway"]`, dates `2025-06-28` to `2025-06-30`, and callback URL. API key is entered.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 11)">0:11</span> <span class="step-description">Execute API Call:</span> "Execute" button clicked in Swagger.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 14)">0:14</span> <span class="step-description">Proxy Usage Logged:</span> Server logs show task started and explicitly state the proxy being used: <span class="highlight">Using proxy: 38.153.152.244:9594 for search.</span> Browser initialization and proxy extension creation logs follow.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 29)">0:29</span> <span class="step-description">Browser Automation Visible:</span> The automated browser window is now shown, displaying the "Voluntary Test Warning" page. (Initial navigation, cookie consent, and registration entry occurred rapidly just before this, confirmed by logs at <span class="timestamp-link" onclick="seekVideo('search-video', 27)">0:18</span>. The warning page and the "Vehicle Details" page are then accepted.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 41)">0:41</span> <span class="step-description">Center Processing & Switching:</span>
                The script first switches from the initial center (Galway) to process the <strong>first requested center, "Athlone"</strong>, using the dropdown.
                After checking Athlone, logs indicate no slots were found within the target date range (`2025-06-28` to `2025-06-30`).
                Therefore, the script switches via the dropdown to process the <strong>next requested center, "Galway"</strong>.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 60)">1:00</span> <span class="step-description">Date/Slot Processing:</span> Browser processes available dates within the range for Galway.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 73)">1:13</span> <span class="step-description">Search Complete & W1 Dispatch:</span>
                Server logs show the search completed successfully (<span class="highlight">Found 28 slots</span>, <span class="highlight">49.93s</span>, <span class="highlight">Search Success: True</span>).
                Immediately following, logs confirm W1 payload preparation, successful webhook sending (<span class="highlight">Status: 200</span>), browser closure, and removal of the temporary proxy extension directory.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('search-video', 80)">1:20</span> <span class="step-description">Webhook Received (W1):</span> The Webhook.site window displays the received webhook. It briefly focuses on the <strong>Request Details & Headers</strong> section (<span class="timestamp-link" onclick="seekVideo('search-video', 81)">1:21</span>), then scrolls through the <strong>Raw Content (Request Body)</strong> showing the <span class="highlight">SlotNotificationPayload</span> JSON, which contains the 28 found slots for Galway on the specified dates (<span class="timestamp-link" onclick="seekVideo('search-video', 88)">1:28</span> onwards).
            </div>
        </div>
        <div class="key-points">
            <h4>Key Takeaways:</h4>
            <ul>
                <li><span class="checkmark">✓</span> <span class="status-implemented"><code>/search</code> endpoint functions as expected.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Proxies from <code>proxies.txt</code> are used for search requests.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Scraper correctly navigates NCTS, handles warnings, switches centers via dropdown, and extracts slots based on parameters.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">W1 webhook delivers results asynchronously with correct data.</span></li>
            </ul>
        </div>
        <h4>Example W1 Payload Snippet:</h4>
        <div class="code-block">
            {
            "event_type": "slots_found",
            "timestamp": 1744359702,
            "vehicle_reg": "192D25407",
            "slots": [
            {
            "center_name": "Galway",
            "date": "2025-06-28",
            "time": "07:30",
            "display_date": "Saturday 28th Jun",
            "booking_value": "383077963-07:30-28/06/2025 07:30:00"
            },
            {
            "center_name": "Galway",
            "date": "2025-06-28",
            "time": "08:00",
            "display_date": "Saturday 28th Jun",
            "booking_value": "383077966-08:00-28/06/2025 08:00:00"
            },
            // ... (multiple slots for 28th June) ...
            {
            "center_name": "Galway",
            "date": "2025-06-30",
            "time": "07:15",
            "display_date": "Monday 30th Jun",
            "booking_value": "383054544-07:15-30/06/2025 07:15:00"
            },
            // ... (multiple slots for 30th June) ...
            {
            "center_name": "Galway",
            "date": "2025-06-30",
            "time": "15:45",
            "display_date": "Monday 30th Jun",
            "booking_value": "383055981-16:00-30/06/2025 15:45:00"
            }
            ],
            "search_duration": 49.93, // Matches log
            "success": true // Matches log
            }
        </div>
    </section>

    <section class="demo-section">
        <h2>2. Demo: Slot Validation (<span class="highlight">/validate</span>)</h2>
        <p>This shows the synchronous <code>/validate</code> endpoint quickly checking if a specific slot (found previously) is still available. This uses a fresh browser <strong>without a proxy</strong> for speed.</p>

        <div class="video-container">
            <iframe id="validate-video" src="https://www.youtube.com/embed/U68GorpQVXM?rel=0&vq=hd720" frameborder="0" allowfullscreen></iframe>
            <p class="video-note">Video shows: Initial view of available NCTS slot, API call setup (Swagger), server logs (mentioning no proxy), fast browser action repeating search steps, final log confirming availability, direct JSON response in Swagger.</p>
        </div>

        <div class="timeline">
            <h4>Process Steps:</h4>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 0)">0:00</span> <span class="step-description">Initial State:</span> NCTS browser window shows slots for Ballina on Sat 7th June, confirming <span class="highlight">14:40</span> is available. Swagger UI shows <span class="highlight">POST /validate</span> ready.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 3)">0:03</span> <span class="step-description">API Call Setup:</span> Swagger request body is configured to validate the specific slot: `{"vehicle_reg": "192D25407", "center_name": "Ballina", "slot_date": "2025-06-07", "slot_time": "14:40"}`.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 6)">0:06</span> <span class="step-description">Execute API Call:</span> "Execute" button clicked in Swagger.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 11)">0:11</span> <span class="step-description">No Proxy Logged:</span> Server logs show request received and confirm <span class="highlight">Initializing new browser for validation (no proxy).</span>
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 17)">0:17</span> <span class="step-description">Check Automation:</span> A new browser window performs the NCTS navigation: Home page, reg entry, submit, details page, center selection (Ballina selected), date selection (7th June selected), time selection (14:40 not visible but selected via the DOM).
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 41)">0:41</span> <span class="step-description">Validation Success Logged:</span> Browser closes. Server logs explicitly confirm success: <span class="highlight">Validation SUCCESS: Slot 2025-06-07 14:40 at Ballina IS AVAILABLE.</span> Duration is logged.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('validate-video', 61)">1:01</span> <span class="step-description">Synchronous Response Displayed:</span> Swagger UI shows the direct API JSON response (Code 200) confirming <span class="highlight">"is_available": true</span> and matching validated slot details.
            </div>
        </div>
        <div class="key-points">
            <h4>Key Takeaways:</h4>
            <ul>
                <li><span class="checkmark">✓</span> <span class="status-implemented"><code>/validate</code> endpoint provides quick, synchronous slot checks.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Does <strong>not</strong> use proxies, optimizing for speed.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Effectively repeats the search navigation for the specific center/date to verify the target time slot's presence.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Useful for confirming availability just before attempting to hold a slot (R2).</span></li>
            </ul>
        </div>
        <h4>Example <code>/validate</code> Response:</h4>
        <div class="code-block">
            {
            "status": "success",
            "message": "Slot validation completed",
            "data": {
            "vehicle_reg": "192D25407",
            "center_name": "Ballina",
            "slot_date": "2025-06-07",
            "slot_time": "14:40",
            "is_available": true, // Confirmed by logs and response
            "validation_duration": 33.24 // Matches log
            }
            }
        </div>
    </section>

    <section class="demo-section">
        <h2>3. Demo: Booking & Holding Slot (<span class="highlight">/book</span> <span class="arrow">→</span> W2 <span class="highlight">holding_slot</span>)</h2>
        <p>This demonstrates the core R2 functionality: attempting to book a specific slot, navigating NCTS using <strong>random data</strong>, reaching the payment page to initiate the hold, and starting the background refresh task. This uses a <strong>test proxy</strong>.</p>

        <div class="video-container">
            <iframe id="book-hold-video" src="https://www.youtube.com/embed/lyw6223EXYE?rel=0&vq=hd720" frameborder="0" allowfullscreen></iframe>
            <p class="video-note">Video shows: API call to <code>/book</code> (Swagger), logs (proxy used), browser navigating NCTS, <em>entering random contact details</em>, selecting slot, <em>reaching payment page</em>, logs showing hold start & W2 dispatch, webhook receiver getting W2.</p>
        </div>

        <div class="timeline">
            <h4>Process Steps:</h4>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 4)">0:04</span> <span class="step-description">API Call Setup:</span> Swagger UI shows request body for <span class="highlight">POST /book</span>: `{"vehicle_reg": "192D25407", "slot_details": {"center_name": "Ballina", "date": "2025-06-07", "time": "14:40"}, "callback_url": "https://webhook.site/..."}`.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 10)">0:10</span> <span class="step-description">Execute API Call:</span> "Execute" button clicked in Swagger.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 12)">0:12</span> <span class="step-description">Proxy Usage Logged:</span> Server logs show task started and confirm proxy usage: <span class="highlight">Using proxy: 38.153.152.244:9594 for booking.</span> Browser initialization begins.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 16)">0:16</span> <span class="step-description">NCTS Navigation:</span> Browser navigates NCTS: Home, Reg Entry, Warnings, Vehicle Details, Center Selection (Ballina), Date Selection (7th June), Time Selection (14:40).
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 49)">0:49</span> <span class="step-description">Random Data Entry:</span> <strong>The script enters randomly generated contact details (email, address, phone).</strong> Form is submitted.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 64)">1:04</span> <span class="step-description">Booking Summary:</span> Browser shows the summary page confirming the selected slot details.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 70)">1:10</span> <span class="step-description">Proceed to Payment:</span> "PROCEED TO PAYMENT" button clicked. Browser shows loading message.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 75)">1:15</span> <span class="step-description">Payment Page Reached:</span> Browser successfully loads the complete payment page, showing the payment iframe/details. Logs confirm (<span class="highlight">Reached payment page... True</span>).
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 80)">1:20</span> <span class="step-description">Hold Initiated & W2 Sent:</span> Server logs confirm: Hold session started (<span class="highlight">Attempting to start holding session... Successfully started...</span>), W2 webhook prepared and sent successfully (<span class="highlight">Preparing W2 payload. Status: 'holding_slot'... Sent successfully (Status: 200)</span>). Refresh task starts.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 90)">1:30</span> <span class="step-description">Webhook Received (W2 - Success):</span> The Webhook.site window displays the received webhook. It initially shows the <strong>Request Details & Headers</strong> section. Then, the <strong>Raw Content (Request Body)</strong> is shown, displaying the <span class="highlight">BookingInitiatedPayload</span> JSON with <span class="highlight">"status": "holding_slot"</span> and the unique <span class="highlight">hold_session_id: "hold_1744225842_1254"</span>.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 110)">1:50</span> <span class="step-description">Background Refresh Logs:</span> Server logs show the `Refresh Task` is running. A fade transition indicates time passing.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 121)">2:01</span> <span class="step-description">First Refresh Success:</span> Logs show <span class="highlight">Attempting refresh #1...</span> followed by <span class="highlight">Refresh #1 successful... Iframe and inner element found.</span> The hold is maintained.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 131)">2:11</span> <span class="step-description">Browser View Post-Refresh:</span> Focus shifts to the automated browser, still showing the NCTS payment page active with timer countdown visible.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 138)">2:18</span> <span class="step-description">Manual Check Start (Different Reg):</span> Focus switches to a <strong>separate manual browser</strong>. A <em>different</em> registration ID ('12D12345') is entered.
            </div>

            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 151)">2:31</span> <span class="step-description">Manual Check Result (Different Reg):</span> User manually navigates to Ballina / Sat 7th June. The target slot <span class="highlight">14:40</span> is <strong>visibly missing / unavailable</strong> (<span class="timestamp-link" onclick="seekVideo('book-hold-video', 168)">2:48</span>).
            </div>

            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 176)">2:56</span> <span class="step-description">Manual Check Start (Correct Reg):</span> User navigates back to homepage in manual browser and enters the <strong>correct</strong> registration ID ('192D25407').
            </div>

            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('book-hold-video', 193)">3:13</span> <span class="step-description">Manual Check Result (Correct Reg):</span> User manually navigates to Ballina / Sat 7th June. The target slot <span class="highlight">14:40</span> is <strong>visibly present and available</strong> for selection. This confirms the slot is held specifically for '192D25407'.
            </div>
        </div>
        <div class="key-points">
            <h4>Key Takeaways:</h4>
            <ul>
                <li><span class="checkmark">✓</span> <span class="status-implemented"><code>/book</code> endpoint initiates the reservation process.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Proxies from <code>proxies.txt</code> are used for booking requests.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented"><strong>Random contact details</strong> are used during navigation (concierge model).</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Successfully reaches the NCTS payment page to <strong>secure the hold</strong>.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Background task starts to <strong>maintain the hold</strong> via periodic refreshes.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">W2 webhook correctly reports <span class="highlight">"holding_slot"</span> status and provides the <span class="highlight">hold_session_id</span>.</span></li>
                <li><span class="status-info">ℹ️</span> The end-user must now manually book this slot on NCTS.ie using their own details before the hold expires.</li>
            </ul>
        </div>
        <h4>Example W2 Payload (<span class="highlight">holding_slot</span>):</h4>
        <div class="code-block">
            {
            "event_type": "booking_initiated",
            "timestamp": 1744225842,
            "vehicle_reg": "192D25407",
            "booking_info": {
            "vehicle_reg": "192D25407",
            "task_id": "book_1744225778_3695",
            "slot_details": {
            "center_name": "Ballina",
            "date": "2025-06-07",
            "time": "14:40"
            },
            "registration": "192D25407",
            "service_type": "Periodic Inspection",
            "center": "Ballina",
            "date": "Saturday 7th June 2025",
            "time": "14:40",
            "fee": "€60.00",
            "summary_page_url": "https://www.ncts.ie/...",
            "payment_page_url": "https://pay.sandbox.realexpayments.com/pay.cgi",
            "status": "holding_slot",
            "timestamp": 1744225842,
            "hold_session_id": "hold_1744225842_1254",
            "message": "Slot reserved and held successfully (Hold ID: hold_1744225842_1254). User must book manually on NCTS.ie.",
            "expires_at": 1744227642,
            "error": null
            },
            "expires_at": 1744227642
            }
        </div>
    </section>

    <section class="demo-section">
        <h2>4. Demo: Cancelling Slot Hold (<span class="highlight">/cancel</span>)</h2>
        <p>This demonstrates using the <code>/cancel</code> endpoint with the <span class="highlight">hold_session_id</span> obtained previously to immediately stop the holding task and release all associated resources (browser, proxy extension).</p>

        <div class="video-container">
            <iframe id="cancel-video" src="https://www.youtube.com/embed/cSsAhgwTKoI?rel=0&vq=hd720" frameborder="0" allowfullscreen></iframe>
            <p class="video-note">Video shows: API call setup (Swagger) with <code>hold_session_id</code>, server logs showing task cancellation, browser closing, resource cleanup, API response, and optional confirmation webhook reception.</p>
        </div>

        <div class="timeline">
            <h4>Process Steps:</h4>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('cancel-video', 0)">0:00</span> <span class="step-description">Initial State:</span> Swagger UI shows <span class="highlight">POST /cancel</span>. The NCTS browser holding the slot is visible (same as previous demo /book step).
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('cancel-video', 2)">0:02</span> <span class="step-description">API Call Setup:</span> Swagger request body includes the <span class="highlight">session_id: "hold_1744225842_1254"</span> (<strong>obtained from the successful W2 webhook in the previous demo /book step</strong>), vehicle reg, reason, and callback URL.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('cancel-video', 5)">0:05</span> <span class="step-description">Execute API Call:</span> "Execute" button clicked in Swagger.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('cancel-video', 10)">0:10</span> <span class="step-description">Cancellation Process Logged:</span> Server logs show the cancellation request received, followed immediately by the cleanup sequence: session removed from tracking, refresh task cancelled, browser closed, temp directory removed. Subsequently, the confirmation webhook send is logged, and the `/cancel` API request itself completes successfully ( - 200 OK).
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('cancel-video', 25)">0:25</span> <span class="step-description">API Response Displayed:</span> Swagger UI shows the direct API response confirming success: <span class="highlight">"status": "success"</span>, <span class="highlight">"close_success": true</span>.
            </div>
            <div class="timeline-item">
                <span class="timestamp-link" onclick="seekVideo('cancel-video', 34)">0:34</span> <span class="step-description">Confirmation Webhook Received & Visible:</span> The Webhook.site window displays the received cancellation confirmation webhook. The JSON payload becomes clearly visible, confirming <span class="highlight">event_type: "session_cancelled"</span>, the correct session ID, and <span class="highlight">"success": true</span>.
            </div>
        </div>
        <div class="key-points">
            <h4>Key Takeaways:</h4>
            <ul>
                <li><span class="checkmark">✓</span> <span class="status-implemented"><code>/cancel</code> endpoint successfully stops an active hold session using its ID.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Stops the background refresh task.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Properly closes the browser instance.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Cleans up temporary files (proxy extension directory).</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">Optionally sends a confirmation webhook upon completion.</span></li>
                <li><span class="status-info">ℹ️</span> Essential for efficient resource management.</li>
            </ul>
        </div>
        <h4>Example <code>/cancel</code> Response:</h4>
        <div class="code-block">
            {
            "status": "success",
            "message": "Cancellation request processed for session hold_1744225842_1254. Cleanup success: True",
            "data": {
            "session_id": "hold_1744225842_1254",
            "vehicle_reg": "192D25407",
            "found": true,
            "close_success": true,
            "reason": "Test demo for cancel endpoint", // Matches request body
            "timestamp": 1744227105, 
            "error": null
            }
            }
        </div>
        <h4>Example Confirmation Webhook Payload:</h4>
        <div class="code-block">
            {
            "event_type": "session_cancelled",
            "timestamp": 1744227105, 
            "session_id": "hold_1744225842_1254", // Matches cancelled ID
            "vehicle_reg": "192D25407", // Matches request
            "reason": "Test demo for cancel endpoint", // Matches request
            "success": true, // Confirms successful cleanup
            "error": null
            }
        </div>
    </section>

    <section class="demo-section">
        <h2>5. Explanation: Confirmation Flow (<span class="highlight">/payment</span> <span class="arrow">→</span> W3)</h2>
        <p>This step <strong>does not involve browser interaction</strong> by the API.</p>
        <p>After the client application receives the W2 webhook (hopefully with <span class="highlight">"status": "holding_slot"</span>), it should instruct the user to book manually. To complete the API workflow loop, the client application then calls the <span class="highlight">POST /payment</span> (R3) endpoint, sending back the exact <span class="highlight">booking_info</span> object it received in W2.</p>
        <p>The API's <code>/payment</code> endpoint simply:</p>
        <ol>
            <li>Receives the <span class="highlight">booking_info</span> from the request.</li>
            <li>Checks the <span class="highlight">status</span> field within that <span class="highlight">booking_info</span>.</li>
            <li>Sends the W3 (<span class="highlight">BookingResultPayload</span>) webhook to confirm whether the initial hold attempt (reported in W2) was successful or not.</li>
        </ol>
        <p>It acts purely as an acknowledgment and final status reporting mechanism based on the prior <code>/book</code> action. It <strong>does not</strong> process payments or interact further with NCTS.</p>

        <h4>Example R3 Request & W3 Response:</h4>
        <p>If W2 reported <code>"status": "holding_slot"</code>:</p>
        <p>1. Client App sends R3 Request to <span class="highlight">POST /payment</span>:</p>
        <div class="code-block">
            {
            "vehicle_reg": "12D12345",
            "booking_info": { /* The entire booking_info object from W2, including "status": "holding_slot", "hold_session_id": "..." */ },
            "callback_url": "https://your_app.com/webhook/w3_final_result"
            }
        </div>
        <p>2. API sends W3 Webhook:</p>
        <div class="code-block">
            {
            "event_type": "booking_result",
            "timestamp": 1712150600,
            "vehicle_reg": "12D12345",
            "booking_info": { /* The same booking_info object passed in R3 */ },
            "success": true, // Because W2 status was "holding_slot"
            "confirmation_number": "PENDING_USER_ACTION (Hold ID: hold_1712150100_5678)",
            "error_message": null,
            "payment_url": null // Always null
            }
        </div>
        <div class="key-points">
            <h4>Key Takeaways:</h4>
            <ul>
                <li><span class="checkmark">✓</span> <span class="status-implemented"><code>/payment</code> endpoint logic is implemented.</span></li>
                <li><span class="checkmark">✓</span> <span class="status-implemented">It correctly triggers the W3 webhook based on the W2 status.</span></li>
                <li><span class="status-info">ℹ️</span> Confirms the API's part of the workflow (finding and holding) is complete/failed, separate from the user's manual booking/payment.</li>
            </ul>
        </div>
    </section>


    <section class="intro-section">
        <h2>6. Summary </h2>
        <p>This demonstration confirms that the NCTS API v1.5.1 successfully implements the core "concierge" workflow:</p>
        <ul>
            <li><span class="checkmark">✓</span> Searching for slots with proxy support (R1 <span class="arrow">→</span> W1).</li>
            <li><span class="checkmark">✓</span> Validating specific slots quickly without proxies (R1a).</li>
            <li><span class="checkmark">✓</span> Initiating booking, using random data and proxies, reaching the payment page to hold the slot, and managing the hold via background refresh (R2 <span class="arrow">→</span> W2).</li>
            <li><span class="checkmark">✓</span> Confirming the hold initiation status (R3 <span class="arrow">→</span> W3).</li>
            <li><span class="checkmark">✓</span> Cancelling active holds and cleaning up resources (R4).</li>
        </ul>
        
    </section>

    <footer>
        <p>NCTS Automation API v1.5.1 | Developed by Leonard Cote | April 2025</p>
    </footer>

    <script>
        // Function to seek to a specific time in YouTube videos
        function seekVideo(videoId, seconds) {
            const iframe = document.getElementById(videoId);
            if (iframe) {
                // Get the current src
                const src = iframe.src;
                // Extract the base URL
                const baseUrl = src.split('?')[0];
                // Create the new URL with the start time parameter
                const newSrc = `${baseUrl}?rel=0&vq=hd720&start=${seconds}`;
                // Update the iframe src
                iframe.src = newSrc;
            } else {
                console.error("Video iframe not found:", videoId);
            }
        }
    </script>
</body>
</html>